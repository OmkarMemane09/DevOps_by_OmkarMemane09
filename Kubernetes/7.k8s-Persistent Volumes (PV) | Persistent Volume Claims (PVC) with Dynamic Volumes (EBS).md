#  Kubernetes Persistent Volumes (PV) & Persistent Volume Claims (PVC) 

## What are Persistent Volumes (PV) and Persistent Volume Claims (PVC)?

Kubernetes Pods are ephemeral(lasting or used for only a short period of time) ! By default, if a Pod dies or is replaced, any data it stores is **lost**. **Persistent Volumes (PV)** and **Persistent Volume Claims (PVC)** are Kubernetes abstractions that let you store data *outside* the Pod, so it survives restarts, rescheduling, and even cluster upgrades.

---

##  Persistent Volume (PV)

A **Persistent Volume (PV)** is a piece of storage in your cluster:
- Provisioned by an admin (static) or by Kubernetes using a StorageClass (dynamic).
- Backed by physical devices (local disk, NFS, AWS EBS, etc).
- Independent of Pods or namespaces.

### Key Points
- Cluster-scoped resource (NOT namespaced)
- Supports access modes: ReadWriteOnce, ReadOnlyMany, ReadWriteMany
- Retains data according to reclaim policy (Retain, Delete, Recycle)

---

##  Persistent Volume Claim (PVC)

A **PVC** is a user's request for storage:
- Specifies storage size, access mode, and (optionally) a StorageClass.
- When a compatible PV is found (or dynamically provisioned), Kubernetes binds the PVC to the PV.
- Pod mounts the PVC as a regular volume.

### Key Points
- Namespaced resource (belongs to a single namespace)
- Enables multi-tenant, self-service storage

---
# üóÇÔ∏è Kubernetes Persistent Volumes (PV) & Persistent Volume Claims (PVC) | Practical Demo

## üßë‚Äçüíª Overview

Kubernetes Persistent Volumes (PV) and Persistent Volume Claims (PVC) enable Pods to use reliable, long-lived storage, ensuring app data survives Pod restarts, re-scheduling, and upgrades. 

---

## üìÅ Step 0: Prepare Local Storage (Demo Only)

#### Create a local folder for PV storage on your node or VM
```bash
mkdir -p /mnt/data
```
#### Verify disk space and type
```bash
df -hT # Verify disk space and type
```
---

## 1Ô∏è‚É£ Step 1: Create a Persistent Volume (PV)
```bash
nano  persistentvolume.yaml
```
**Manifest: `persistentvolume.yaml`**
```yaml
apiVersion: v1   # API version used for PersistentVolume resource
kind: PersistentVolume   # Declares this manifest as a PersistentVolume (PV)
metadata: 
    name: my-vol   # Name of the PV (unique identifier in the cluster)

spec: 
  capacity: 
    storage: 5Gi   # The size of the PV (5 Gigabytes)

  volumeMode: Filesystem   # Specifies that the volume will be mounted as a filesystem (not raw block)

  accessModes:
      - ReadWriteOnce   # Only one node can mount this volume for read/write at a time

  persistentVolumeReclaimPolicy: Retain   # What happens when the PVC is deleted:
                                          # Retain ‚Üí Keep the data
                                          # Delete ‚Üí Remove the PV and data
                                          # Recycle ‚Üí Wipe and make PV available again (deprecated)

  storageClassName: rohit   # StorageClass name associated with this PV (used for dynamic provisioning)

  local:
    path: /mnt/data   # Path on the node‚Äôs local filesystem where data will be stored

  nodeAffinity:   # Ensures the PV is only usable on specific nodes
    required:
      nodeSelectorTerms: 
        - matchExpressions:
            - key: kubernetes.io/hostname   # Node label key used for selection
              operator: In                  # Operator meaning "must be in this list"
              values: ["controlplane"]      # Only the node with hostname "controlplane" can use this PV

```

**Apply:**
```bash
kubectl apply -f persistentvolume.yaml
```
```bash
kubectl get pv
```
```bash
kubectl describe pv my-vol
```
---

## 2Ô∏è‚É£ Step 2: Create a Persistent Volume Claim (PVC)

**Manifest: `persistentvolumeclaim.yaml`**

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: my-pvc
spec:
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 5Gi # Request same size as PV
storageClassName: rohit # Match PV StorageClass
volumeName: my-vol # Explicit bind to specific PV

text

**Apply:**
kubectl apply -f persistentvolumeclaim.yaml
kubectl get pvc
kubectl describe pvc my-pvc

text

---

## 3Ô∏è‚É£ Step 3: Create a Pod Using the PVC

**Manifest: `pod.yaml`**

apiVersion: v1
kind: Pod
metadata:
name: my-pod
spec:
containers:
- name: nginx
image: nginx:latest
ports:
- containerPort: 80
volumeMounts:
- mountPath: /usr/share/nginx/html
name: my-vol
volumes:
- name: my-vol
persistentVolumeClaim:
claimName: my-pvc

text

**Apply:**
kubectl apply -f pod.yaml
kubectl get pod my-pod
kubectl describe pod my-pod

text

---

## üí° Test Data Persistence

1. **Write data inside Pod:**
kubectl exec -it my-pod -- sh
echo "Persistent Storage Test!" > /usr/share/nginx/html/index.html
exit

text
2. **Delete Pod and re-create using same PVC:**
kubectl delete pod my-pod

Change pod name in pod.yaml to another-pod, then apply again
kubectl apply -f pod.yaml
kubectl exec -it another-pod -- cat /usr/share/nginx/html/index.html

text
- You should see `"Persistent Storage Test!"` ‚Äî confirming **data persisted** after Pod deletion.

---

## üîé Useful Commands

kubectl get pv
kubectl get pvc
kubectl get pod
kubectl describe pv my-vol
kubectl describe pvc my-pvc

text

---

## üìù Key Concepts and Best Practices

- **Binding:** PVC binds to PV when requirements (size, access modes, storage class) match. PVC and Pod must be in the same namespace[1][6][7][8][9].
- **Reclaim Policy:** Use `Retain` to keep data after PVC deletion, `Delete` to remove PV/data when PVC is deleted.
- **Volume Name:** Set PVC `volumeName` to explicitly bind to a PV, otherwise PVC will bind any matching unbound PV automatically.
- **Access Modes:** `ReadWriteOnce` (RWO) is most common; ensure only one node mounts a local PV for write access.
- **PVC Expansion:** Some storage classes support increasing PVC size (check provider docs).

---

## üèÅ Summary Table

| Resource   | Role                    | YAML Kind       | Namespace  | Example Manifest            |
|------------|-------------------------|-----------------|------------|----------------------------|
| PV         | Cluster storage backend | PersistentVolume| Cluster    | `persistentvolume.yaml`     |
| PVC        | Storage request         | PersistentVolumeClaim | Namespace  | `persistentvolumeclaim.yaml` |
| Pod        | Uses storage via PVC    | Pod             | Namespace  | `pod.yaml`                  |

---
