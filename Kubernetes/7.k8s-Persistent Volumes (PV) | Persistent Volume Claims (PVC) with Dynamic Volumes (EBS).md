#  Kubernetes Persistent Volumes (PV) & Persistent Volume Claims (PVC) 

## What are Persistent Volumes (PV) and Persistent Volume Claims (PVC)?

Kubernetes Pods are ephemeral(lasting or used for only a short period of time) ! By default, if a Pod dies or is replaced, any data it stores is **lost**. **Persistent Volumes (PV)** and **Persistent Volume Claims (PVC)** are Kubernetes abstractions that let you store data *outside* the Pod, so it survives restarts, rescheduling, and even cluster upgrades.

---

##  Persistent Volume (PV)

A **Persistent Volume (PV)** is a piece of storage in your cluster:
- Provisioned by an admin (static) or by Kubernetes using a StorageClass (dynamic).
- Backed by physical devices (local disk, NFS, AWS EBS, etc).
- Independent of Pods or namespaces.

### Key Points
- Cluster-scoped resource (NOT namespaced)
- Supports access modes: ReadWriteOnce, ReadOnlyMany, ReadWriteMany
- Retains data according to reclaim policy (Retain, Delete, Recycle)

---

##  Persistent Volume Claim (PVC)

A **PVC** is a user's request for storage:
- Specifies storage size, access mode, and (optionally) a StorageClass.
- When a compatible PV is found (or dynamically provisioned), Kubernetes binds the PVC to the PV.
- Pod mounts the PVC as a regular volume.

### Key Points
- Namespaced resource (belongs to a single namespace)
- Enables multi-tenant, self-service storage

---
#  Practical Demo

##  Overview

Kubernetes Persistent Volumes (PV) and Persistent Volume Claims (PVC) enable Pods to use reliable, long-lived storage, ensuring app data survives Pod restarts, re-scheduling, and upgrades. 

---

##  Step 0: Prepare Local Storage (Demo Only)

#### Create a local folder for PV storage on your node or VM
```bash
mkdir -p /mnt/data
```
#### Verify disk space and type
```bash
df -hT # Verify disk space and type
```
---

##  Step 1: Create a Persistent Volume (PV)
```bash
nano  persistentvolume.yaml
```
**Manifest: `persistentvolume.yaml`**
```yaml
apiVersion: v1   # API version used for PersistentVolume resource
kind: PersistentVolume   # Declares this manifest as a PersistentVolume (PV)
metadata: 
    name: my-vol   # Name of the PV (unique identifier in the cluster)

spec: 
  capacity: 
    storage: 5Gi   # The size of the PV (5 Gigabytes)

  volumeMode: Filesystem   # Specifies that the volume will be mounted as a filesystem (not raw block)

  accessModes:
      - ReadWriteOnce   # Only one node can mount this volume for read/write at a time

  persistentVolumeReclaimPolicy: Retain   # What happens when the PVC is deleted:
                                          # Retain ‚Üí Keep the data
                                          # Delete ‚Üí Remove the PV and data
                                          # Recycle ‚Üí Wipe and make PV available again (deprecated)

  storageClassName: omkar   # StorageClass name associated with this PV (used for dynamic provisioning)

  local:
    path: /mnt/data   # Path on the node‚Äôs local filesystem where data will be stored

  nodeAffinity:   # Ensures the PV is only usable on specific nodes
    required:
      nodeSelectorTerms: 
        - matchExpressions:
            - key: kubernetes.io/hostname   # Node label key used for selection
              operator: In                  # Operator meaning "must be in this list"
              values: ["controlplane"]      # Only the node with hostname "controlplane" can use this PV

```

**Apply:**
```bash
kubectl apply -f persistentvolume.yaml
```
```bash
kubectl get pv
```
```bash
kubectl describe pv my-vol
```
---

## Step 2: Create a Persistent Volume Claim (PVC)
```bash
nano persistentvolumeclaim.yaml
```

**Manifest: `persistentvolumeclaim.yaml`**
```yaml
apiVersion: v1   # API version for PersistentVolumeClaim resource
kind: PersistentVolumeClaim   # Declares this manifest as a PVC
metadata: 
   name: my-pvc   # Name of the PVC (unique identifier in the namespace)

spec: 
 accessModes:
   - ReadWriteOnce   # Access mode: the PVC requires a volume that can be mounted read/write by only one node

 resources:
   requests:
     storage: 5Gi   # The PVC is requesting 5Gi of storage

 storageClassName: omkar   # Must match the PV's storageClassName so that it binds correctly

 volumeName: my-vol   # Explicitly binds this PVC to the PersistentVolume named "my-vol"
```

**Apply:**
```bash
kubectl apply -f persistentvolumeclaim.yaml
```
```bash
kubectl get pvc
```
```bash
kubectl describe pvc my-pvc
```
---

##  Step 3: Create a Pod Using the PVC
```bash
nano pod.yaml

```
**Manifest: `pod.yaml`**
```yaml
apiVersion: v1   # API version for Pod resource
kind: Pod        # Declares this manifest as a Pod
metadata: 
  name: my-pod   # Name of the Pod

spec:
  containers:
    - name: nginx   # Container name inside the Pod
      image: nginx:latest   # Container image to run (latest Nginx)
      ports:
        - containerPort: 80   # Exposes port 80 (default HTTP port) inside the container

      volumeMounts:   # Defines where to mount volumes inside the container
        - mountPath: "/usr/share/nginx/html"   # Path inside container where volume will be mounted
          name: my-vol   # Must match the volume name defined below

  volumes:   # Volumes available to the Pod
    - name: my-vol   # Name of the volume (referenced above in volumeMounts)
      persistentVolumeClaim:
        claimName: my-pvc   # PVC name ‚Üí binds this volume to the PVC "my-pvc"
 ```

**Apply:**
```bash
kubectl apply -f pod.yaml
```
```bash
kubectl get pod my-pod
```
```bash
kubectl describe pod my-pod
```
---

##  Test that Data is  Persistence or not 

1. **Write data inside Pod:**
```bash
   kubectl exec -it my-pod -- sh
```
```bash
   echo "Persistent Storage Test!" > /usr/share/nginx/html/index.html
   exit
```

2.**Take the IP and curl it**
```bash
   kubectl get pods -o wide
```
```bash
   curl <Paste that ip>
```
3. **Delete Pod and re-create using same PVC:**
```bash
   kubectl delete pod my-pod
```
4. **Check if data is stored in local or not**
```bash
   cd /mnt/data
```
```bash
   ls
```
```bash
   cat index.html
   cd ../..
```

5.**Change pod name in pod.yaml to another-pod, then apply again**
```bash
   kubectl apply -f pod.yaml
```
```bash
   kubectl get pods
```
---

6.**Take the IP and curl it**
```bash
   kubectl get pods -o wide
```
```bash
   curl <Paste that ip>
```
---
## Terminology :
- **Binding:** PVC binds to PV when requirements (size, access modes, storage class) match. PVC and Pod must be in the same namespace.
- **Reclaim Policy:** Use `Retain` to keep data after PVC deletion, `Delete` to remove PV/data when PVC is deleted.
- **Volume Name:** Set PVC `volumeName` to explicitly bind to a PV, otherwise PVC will bind any matching unbound PV automatically.
- **Access Modes:** `ReadWriteOnce` (RWO) is most common; ensure only one node mounts a local PV for write access.
- **PVC Expansion:** Some storage classes support increasing PVC size (check provider docs).

---

## üèÅ Summary Table

| Resource   | Role                    | YAML Kind       | Namespace  | Example Manifest            |
|------------|-------------------------|-----------------|------------|----------------------------|
| PV         | Cluster storage backend | PersistentVolume| Cluster    | `persistentvolume.yaml`     |
| PVC        | Storage request         | PersistentVolumeClaim | Namespace  | `persistentvolumeclaim.yaml` |
| Pod        | Uses storage via PVC    | Pod             | Namespace  | `pod.yaml`                  |

---
